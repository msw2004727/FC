<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>âš½ï¸ å ±åç³»çµ± - æ¸¬è©¦é </title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    :root{
      --bg:#fff; --fg:#111; --card:#f6f6f6; --muted:#666; --bd:#e5e5e5;
      --btn:#111; --btnfg:#fff;
    }
    [data-theme="dark"]{
      --bg:#0b0d10; --fg:#f2f2f2; --card:#141821; --muted:#a0a7b4; --bd:#262c38;
      --btn:#f2f2f2; --btnfg:#0b0d10;
    }
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--fg);}
    .wrap{max-width:980px;margin:0 auto;padding:16px;}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .btn{padding:10px 12px;border-radius:10px;border:1px solid var(--bd);background:transparent;color:var(--fg);cursor:pointer;}
    .btn.primary{background:var(--btn);color:var(--btnfg);border-color:transparent;}
    .small{font-size:12px;color:var(--muted);}
    code, pre{background:rgba(127,127,127,0.12);border-radius:10px;padding:10px;overflow:auto;}
    img{border-radius:999px;}
    input{padding:10px;border-radius:10px;border:1px solid var(--bd);background:transparent;color:var(--fg);width:100%;}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr;}}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px;">
      <div style="font-weight:900;">âš½ï¸ LINE è¶³çƒå ±åç³»çµ± - æ¸¬è©¦é </div>
      <button class="btn" id="themeBtn">ğŸŒ™/â˜€ï¸</button>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:800;margin-bottom:8px;">1) è¨­å®šå€ï¼ˆå…ˆå¡«å¥½å†æŒ‰åˆå§‹åŒ–ï¼‰</div>

        <div class="small">LIFF ID</div>
        <input id="liffId" placeholder="ä¾‹å¦‚ï¼š200xxxxx-xxxxxxx" />

        <div style="height:10px"></div>

        <div class="small">Functions Base URLï¼ˆå¯é¸ï¼‰</div>
        <input id="fnBase" placeholder="ä¾‹å¦‚ï¼šhttps://asia-east1-ä½ çš„å°ˆæ¡ˆ.cloudfunctions.net" />

        <div style="height:10px"></div>

        <div class="small">Firebase Configï¼ˆå¿…å¡«ï¼‰</div>
        <div class="small">åˆ° Firebase Console â†’ Project settings â†’ SDK setup â†’ Config</div>

        <div style="height:8px"></div>

        <div class="row">
          <div style="flex:1;">
            <div class="small">apiKey</div>
            <input id="fb_apiKey" />
          </div>
          <div style="flex:1;">
            <div class="small">authDomain</div>
            <input id="fb_authDomain" />
          </div>
        </div>

        <div style="height:8px"></div>

        <div class="row">
          <div style="flex:1;">
            <div class="small">projectId</div>
            <input id="fb_projectId" />
          </div>
          <div style="flex:1;">
            <div class="small">appId</div>
            <input id="fb_appId" />
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button class="btn primary" id="btnInit">åˆå§‹åŒ–ï¼ˆLIFF + Firebaseï¼‰</button>
          <button class="btn" id="btnClear">æ¸…ç©º</button>
        </div>

        <div style="margin-top:12px" class="small">
          âœ… åˆå§‹åŒ–æˆåŠŸå¾Œï¼Œä½ å°±èƒ½æ¸¬è©¦ï¼šLIFF Profileã€Functions createCustomTokenã€Firebase ç™»å…¥ã€‚
        </div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px;">2) æ¸¬è©¦å‹•ä½œ</div>

        <div class="row" style="margin-bottom:8px;">
          <button class="btn primary" id="btnLiff">å–å¾— LIFF Profile</button>
          <button class="btn" id="btnToken">å‘¼å« createCustomToken</button>
          <button class="btn" id="btnSignOut">Firebase ç™»å‡º</button>
        </div>

        <div class="small">Check-in Tokenï¼ˆæ¸¬è©¦ç”¨ï¼‰</div>
        <input id="checkinToken" placeholder="è²¼ä¸Š getCheckinQrToken ç”¢ç”Ÿçš„ tokenï¼ˆè‹¥ä½ æœ‰åšï¼‰" />

        <div style="height:10px"></div>
        <div class="row">
          <button class="btn" id="btnCheckin">å‘¼å« checkinByTokenï¼ˆå¯é¸ï¼‰</button>
        </div>

        <div style="height:12px"></div>
        <div class="small">ç‹€æ…‹ / Log</div>
        <pre id="log" style="min-height:220px;white-space:pre-wrap;"></pre>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (Modular) via CDN -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

    const els = {
      themeBtn: document.getElementById("themeBtn"),
      btnInit: document.getElementById("btnInit"),
      btnClear: document.getElementById("btnClear"),
      btnLiff: document.getElementById("btnLiff"),
      btnToken: document.getElementById("btnToken"),
      btnSignOut: document.getElementById("btnSignOut"),
      btnCheckin: document.getElementById("btnCheckin"),
      log: document.getElementById("log"),

      liffId: document.getElementById("liffId"),
      fnBase: document.getElementById("fnBase"),

      fb_apiKey: document.getElementById("fb_apiKey"),
      fb_authDomain: document.getElementById("fb_authDomain"),
      fb_projectId: document.getElementById("fb_projectId"),
      fb_appId: document.getElementById("fb_appId"),

      checkinToken: document.getElementById("checkinToken"),
    };

    function log(...args){
      const msg = args.map(a => (typeof a === "string" ? a : JSON.stringify(a, null, 2))).join(" ");
      els.log.textContent += msg + "\n";
      els.log.scrollTop = els.log.scrollHeight;
      console.log(...args);
    }

    function setTheme(t){
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem("theme", t);
    }
    function getTheme(){
      return localStorage.getItem("theme") === "dark" ? "dark" : "light";
    }
    setTheme(getTheme());
    els.themeBtn.onclick = () => setTheme(getTheme() === "dark" ? "light" : "dark");

    // ä¿å­˜/è¼‰å…¥è¨­å®š
    const KEY = "lfss_test_config";
    function saveConfig(){
      const cfg = {
        liffId: els.liffId.value.trim(),
        fnBase: els.fnBase.value.trim(),
        firebase: {
          apiKey: els.fb_apiKey.value.trim(),
          authDomain: els.fb_authDomain.value.trim(),
          projectId: els.fb_projectId.value.trim(),
          appId: els.fb_appId.value.trim(),
        }
      };
      localStorage.setItem(KEY, JSON.stringify(cfg));
    }
    function loadConfig(){
      const raw = localStorage.getItem(KEY);
      if(!raw) return;
      try{
        const cfg = JSON.parse(raw);
        els.liffId.value = cfg.liffId || "";
        els.fnBase.value = cfg.fnBase || "";
        els.fb_apiKey.value = cfg.firebase?.apiKey || "";
        els.fb_authDomain.value = cfg.firebase?.authDomain || "";
        els.fb_projectId.value = cfg.firebase?.projectId || "";
        els.fb_appId.value = cfg.firebase?.appId || "";
      }catch{}
    }
    loadConfig();

    let app = null;
    let auth = null;
    let inited = false;

    async function initAll(){
      saveConfig();

      const liffId = els.liffId.value.trim();
      if(!liffId) { alert("è«‹å¡« LIFF ID"); return; }
      if(!window.liff) { alert("LIFF SDK æœªè¼‰å…¥"); return; }

      const fb = {
        apiKey: els.fb_apiKey.value.trim(),
        authDomain: els.fb_authDomain.value.trim(),
        projectId: els.fb_projectId.value.trim(),
        appId: els.fb_appId.value.trim(),
      };
      if(!fb.apiKey || !fb.authDomain || !fb.projectId || !fb.appId){
        alert("Firebase config è«‹å¡«å®Œæ•´");
        return;
      }

      log("=== åˆå§‹åŒ–é–‹å§‹ ===");
      log("LIFF initâ€¦");
      await window.liff.init({ liffId });
      if(!window.liff.isLoggedIn()){
        log("LIFF æœªç™»å…¥ï¼Œå°å‘ loginâ€¦");
        window.liff.login();
        return;
      }
      log("LIFF âœ… å·²ç™»å…¥");

      log("Firebase initâ€¦");
      app = initializeApp(fb);
      auth = getAuth(app);

      onAuthStateChanged(auth, (u) => {
        if(u) log("Firebase âœ… å·²ç™»å…¥ uid:", u.uid);
        else log("Firebase â›” å°šæœªç™»å…¥");
      });

      inited = true;
      log("=== åˆå§‹åŒ–å®Œæˆ âœ… ===");
    }

    async function getProfile(){
      if(!inited) { alert("è«‹å…ˆåˆå§‹åŒ–"); return; }
      const profile = await window.liff.getProfile();
      log("LIFF Profile:", profile);
      const idToken = window.liff.getIDToken();
      log("LIFF idToken length:", idToken?.length || 0);
      return { profile, idToken };
    }

    async function callCreateCustomToken(){
      if(!inited) { alert("è«‹å…ˆåˆå§‹åŒ–"); return; }

      const { profile, idToken } = await getProfile();
      const fnBase = els.fnBase.value.trim();

      // ä½ åœ¨ functions è£¡ export çš„ https onRequest: createCustomToken
      // èµ° HTTP æ–¹å¼å‘¼å«ï¼ˆä¸éœ€è¦ firebase callableï¼‰
      // URL: {fnBase}/createCustomToken
      if(!fnBase){
        alert("è«‹å¡« Functions Base URLï¼ˆä¾‹å¦‚ï¼šhttps://asia-east1-xxx.cloudfunctions.netï¼‰");
        return;
      }

      log("å‘¼å« createCustomTokenâ€¦");
      const resp = await fetch(`${fnBase}/createCustomToken`, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({
          idToken,
          profile: {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl
          }
        })
      });

      const data = await resp.json();
      log("createCustomToken resp:", data);

      if(!data.token) {
        alert("æ²’æœ‰æ‹¿åˆ° tokenï¼Œè«‹çœ‹ log");
        return;
      }

      log("ç”¨ custom token ç™»å…¥ Firebaseâ€¦");
      await signInWithCustomToken(auth, data.token);
      log("Firebase ç™»å…¥æˆåŠŸ âœ…");
    }

    async function doSignOut(){
      if(!auth) return;
      await signOut(auth);
      log("Firebase å·²ç™»å‡º");
    }

    async function callCheckinByToken(){
      if(!inited) { alert("è«‹å…ˆåˆå§‹åŒ–"); return; }
      if(!auth?.currentUser) { alert("è«‹å…ˆ Firebase ç™»å…¥ï¼ˆå‘¼å« createCustomTokenï¼‰"); return; }

      const token = els.checkinToken.value.trim();
      if(!token) { alert("è«‹è²¼ä¸Š token"); return; }

      // é€™è£¡ç”¨ HTTP call ç‰ˆæœ¬æœƒéœ€è¦ä½ è‡ªå·±åšä¸€å€‹ onRequest endpointï¼›
      // ç›®å‰ä½  functions checkinByToken æ˜¯ onCall callable
      // æ‰€ä»¥é€™å€‹æ¸¬è©¦å…ˆæç¤ºä½ ï¼šè¦æ¸¬ onCall å»ºè­°åœ¨ React/Vite ç”¨ httpsCallable
      log("âš ï¸ checkinByToken ç›®å‰æ˜¯ functions.https.onCallï¼ˆcallableï¼‰ï¼Œæœ¬ç´” HTML é ä¸ç›´æ¥å‘¼å«ã€‚");
      log("å»ºè­°ï¼šå…ˆåœ¨ React ç‰ˆç”¨ httpsCallable æ¸¬ï¼Œæˆ–æˆ‘å¹«ä½ å¦å¤–åŠ ä¸€å€‹ /checkinByTokenHttp endpointã€‚");
    }

    // ç¶å®šæŒ‰éˆ•
    els.btnInit.onclick = initAll;
    els.btnClear.onclick = () => {
      localStorage.removeItem(KEY);
      location.reload();
    };
    els.btnLiff.onclick = () => getProfile().catch(e => log("ERR", e.message));
    els.btnToken.onclick = () => callCreateCustomToken().catch(e => log("ERR", e.message));
    els.btnSignOut.onclick = () => doSignOut().catch(e => log("ERR", e.message));
    els.btnCheckin.onclick = () => callCheckinByToken().catch(e => log("ERR", e.message));

    log("âœ… æ¸¬è©¦é å·²è¼‰å…¥ã€‚å…ˆå¡« LIFF / Firebase / Functions Base URL â†’ æŒ‰ã€Œåˆå§‹åŒ–ã€ã€‚");
  </script>
</body>
</html>

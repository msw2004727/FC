<!DOCTYPE html>
<html lang="zh-Hant" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>圖斯特Hub — 運動報名系統</title>
  <meta property="og:description" content="此系統由小麥開發，有興趣請接洽圖斯特。">
  <link rel="icon" href="data:,">
  <!-- CDN 預連線 + 預載入（讓瀏覽器在 HTML 解析階段就開始下載 SDK） -->
  <link rel="preconnect" href="https://www.gstatic.com">
  <link rel="preconnect" href="https://static.line-scdn.net">
  <link rel="preconnect" href="https://firestore.googleapis.com">
  <link rel="preconnect" href="https://firebasestorage.googleapis.com">
  <link rel="preconnect" href="https://identitytoolkit.googleapis.com">
  <link rel="preconnect" href="https://line-scdn.net" crossorigin>
  <link rel="preload" href="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js" as="script">
  <link rel="preload" href="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js" as="script">
  <link rel="preload" href="https://static.line-scdn.net/liff/edge/2/sdk.js" as="script">
  <!-- 一鍵清快取：網址加 ?clear=1 即可（LINE 內建瀏覽器適用） -->
  <script>
  (function(){
    var V='20260221f';
    var isProd = location.hostname === 'msw2004727.github.io';
    // ?clear=1 強制清快取
    if(location.search.indexOf('clear=1')!==-1){
      if('caches' in window) caches.keys().then(function(k){k.forEach(function(n){caches.delete(n)})});
      if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(w){w.unregister()})});
      var old=['sporthub_auto_exp_rules','sporthub_auto_exp_logs'];
      old.forEach(function(k){try{localStorage.removeItem(k)}catch(e){}});
      // 正式版 hostname：清快取時一併重置為 production 模式
      if(isProd) localStorage.setItem('sporthub_mode','production');
      localStorage.setItem('sporthub_cache_ver',V);
      location.replace(location.pathname);
      return;
    }
    // 自動偵測版本變化 → 清 SW cache + 修正被舊 bug 錯設為 demo 的模式
    var prev=localStorage.getItem('sporthub_cache_ver');
    if(prev&&prev!==V){
      if('caches' in window) caches.keys().then(function(k){k.forEach(function(n){caches.delete(n)})});
      if('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(w){w.unregister()})});
      // 正式版 hostname：版本更新時重置為 production（修復舊版自動退回 demo 的殘留）
      if(isProd && localStorage.getItem('sporthub_mode')==='demo'){
        localStorage.setItem('sporthub_mode','production');
      }
    }
    localStorage.setItem('sporthub_cache_ver',V);
  })();
  </script>
  <!-- CSS 模組化載入（base → layout → 功能模組） -->
  <link rel="stylesheet" href="css/base.css?v=20260221f">
  <link rel="stylesheet" href="css/layout.css?v=20260221f">
  <link rel="stylesheet" href="css/home.css?v=20260221f">
  <link rel="stylesheet" href="css/activity.css?v=20260221f">
  <link rel="stylesheet" href="css/team.css?v=20260221f">
  <link rel="stylesheet" href="css/profile.css?v=20260221f">
  <link rel="stylesheet" href="css/message.css?v=20260221f">
  <link rel="stylesheet" href="css/tournament.css?v=20260221f">
  <link rel="stylesheet" href="css/shop.css?v=20260221f">
  <link rel="stylesheet" href="css/scan.css?v=20260221f">
  <link rel="stylesheet" href="css/admin.css?v=20260221f">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <!-- 手機除錯面板：網址加 ?debug=1 啟用 -->
  <script>
  if(location.search.indexOf('debug=1')!==-1){
    var _dbg=document.createElement('div');
    _dbg.id='_debug';
    _dbg.style.cssText='position:fixed;bottom:70px;left:0;right:0;max-height:40vh;overflow:auto;background:rgba(0,0,0,.92);color:#0f0;font:11px/1.5 monospace;padding:8px 10px;z-index:99999;word-break:break-all;-webkit-overflow-scrolling:touch';
    _dbg.innerHTML='<div style="color:#888;border-bottom:1px solid #333;padding-bottom:4px;margin-bottom:4px">== Debug Console ==</div>';
    document.documentElement.appendChild(_dbg);
    function _addDbg(t,a){var d=document.createElement('div');d.style.color=t==='error'?'#f55':t==='warn'?'#fa0':'#0f0';d.textContent='['+t+'] '+Array.from(a).map(function(x){try{return typeof x==='object'?JSON.stringify(x):String(x)}catch(e){return String(x)}}).join(' ');_dbg.appendChild(d);_dbg.scrollTop=_dbg.scrollHeight}
    var _oL=console.log,_oE=console.error,_oW=console.warn;
    console.log=function(){_oL.apply(console,arguments);_addDbg('log',arguments)};
    console.error=function(){_oE.apply(console,arguments);_addDbg('error',arguments)};
    console.warn=function(){_oW.apply(console,arguments);_addDbg('warn',arguments)};
    window.addEventListener('error',function(e){_addDbg('error',[e.message,e.filename+':'+e.lineno])});
    window.addEventListener('unhandledrejection',function(e){var r=e.reason;var msg='(unknown)';try{if(r instanceof Error){msg=r.message+(r.stack?'\n'+r.stack:'')}else if(typeof r==='object'&&r!==null){msg=JSON.stringify(r)||String(r)}else{msg=String(r)}}catch(x){msg=String(r)}_addDbg('error',['Promise rejected:',msg])});
  }
  </script>
  <script>
    // 早期模式偵測：防止正式版重整時閃現 Demo 畫面
    (function(){
      var mode = localStorage.getItem('sporthub_mode') ||
        (location.hostname === 'msw2004727.github.io' ? 'production' : 'demo');
      if (mode !== 'demo') {
        document.documentElement.classList.add('prod-early');
      }
    })();
  </script>

  <!-- ============ TOP BAR ============ -->
  <header id="top-bar">
    <button id="menu-toggle" aria-label="選單">
      <span></span><span></span><span></span>
    </button>
    <div class="logo">
      <span class="logo-text">圖斯特Hub</span>
    </div>
    <div class="top-bar-right">
      <div class="sport-picker-wrapper" id="sport-picker-wrapper">
        <button class="sport-picker-btn" id="sport-picker-btn" aria-label="選擇運動類別">
          <span class="sport-picker-icon">⚽</span>
        </button>
        <div class="sport-picker-dropdown" id="sport-picker-dropdown">
          <div class="sport-picker-header">選擇運動類別</div>
          <button class="sport-picker-item active" data-sport="football">
            <span class="sp-icon">⚽</span><span>足球</span>
          </button>
          <button class="sport-picker-item locked" data-sport="basketball" disabled>
            <span class="sp-icon">🏀</span><span>籃球</span><span class="sp-lock">🔒</span>
          </button>
          <button class="sport-picker-item locked" data-sport="volleyball" disabled>
            <span class="sp-icon">🏐</span><span>排球</span><span class="sp-lock">🔒</span>
          </button>
          <button class="sport-picker-item locked" data-sport="tennis" disabled>
            <span class="sp-icon">🎾</span><span>網球</span><span class="sp-lock">🔒</span>
          </button>
          <button class="sport-picker-item locked" data-sport="badminton" disabled>
            <span class="sp-icon">🏸</span><span>羽球</span><span class="sp-lock">🔒</span>
          </button>
        </div>
      </div>
      <div id="points-display" class="points-display" title="累計積分">
        <span class="points-icon">P</span>
        <span class="points-value" id="points-value">0</span>
      </div>
      <button id="notif-btn" aria-label="通知">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
        <span class="notif-badge" id="notif-badge" style="display:none"></span>
      </button>
      <div class="role-switcher-wrapper" id="role-switcher-wrapper" style="display:none">
        <button id="role-avatar-btn" class="role-avatar-btn" aria-label="切換身份">
          <div class="role-avatar">麥</div>
          <span class="role-current-label">一般用戶</span>
          <span class="role-arrow">▼</span>
        </button>
        <div id="role-dropdown" class="role-dropdown">
          <div class="role-dropdown-header">切換 Demo 身份</div>
          <button class="role-dropdown-item active" data-role="user">
            <span class="role-icon">U</span>
            <span>一般用戶</span>
          </button>
          <button class="role-dropdown-item" data-role="coach">
            <span class="role-icon">C</span>
            <span>教練</span>
          </button>
          <button class="role-dropdown-item" data-role="captain">
            <span class="role-icon">L</span>
            <span>領隊</span>
          </button>
          <button class="role-dropdown-item" data-role="venue_owner">
            <span class="role-icon">V</span>
            <span>場主</span>
          </button>
          <button class="role-dropdown-item" data-role="admin">
            <span class="role-icon">A</span>
            <span>管理員</span>
          </button>
          <button class="role-dropdown-item" data-role="super_admin">
            <span class="role-icon">S</span>
            <span>總管</span>
          </button>
        </div>
      </div>
      <div id="line-login-wrapper" class="line-login-wrapper" style="display:none">
        <button id="line-login-btn" class="line-login-btn" onclick="LineAuth.login()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="#fff"><path d="M12 2C6.48 2 2 5.83 2 10.5c0 4.18 3.66 7.68 8.58 8.38.33.07.78.22.9.5.1.26.07.66.03.92l-.15.86c-.04.26-.2 1.01.88.55s5.88-3.47 8.03-5.93C22.08 13.79 22 12.18 22 10.5 22 5.83 17.52 2 12 2z"/></svg>
          LINE 登入
        </button>
        <div id="line-user-topbar" class="line-user-topbar" style="display:none">
          <img id="line-avatar-topbar" class="line-avatar-topbar" src="" alt="" onclick="App.toggleUserMenu()">
          <div id="user-menu-dropdown" class="user-menu-dropdown" style="display:none">
            <div class="user-menu-name" id="user-menu-name"></div>
            <div class="user-menu-divider"></div>
            <button class="user-menu-item" onclick="App.showPage('page-profile'); App.toggleUserMenu()">我的資料</button>
            <button class="user-menu-item user-menu-logout" onclick="App.logoutLine()">登出</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ============ SIDE DRAWER ============ -->
  <div id="drawer-overlay"></div>
  <nav id="side-drawer">
    <div class="drawer-header">
      <div class="drawer-user">
        <div class="drawer-avatar" id="drawer-avatar">麥</div>
        <div>
          <div class="drawer-name" id="drawer-name">冠軍.全勤.小麥</div>
          <div class="drawer-role-tag" id="drawer-role-tag">一般用戶</div>
        </div>
      </div>
    </div>
    <div class="drawer-menu" id="drawer-menu"></div>
    <div class="drawer-footer">
      <button id="theme-toggle">
        <span>深色模式</span>
        <div class="toggle-switch"><div class="toggle-knob"></div></div>
      </button>
      <div id="lang-switcher" class="lang-switcher">
        <span class="lang-label">語言</span>
        <select id="lang-select" onchange="App.switchLanguage(this.value)"></select>
      </div>
    </div>
  </nav>

  <!-- ============ MAIN CONTENT（由 PageLoader 載入 pages/*.html） ============ -->
  <main id="main-content"></main>

  <!-- ============ BOTTOM TAB BAR ============ -->
  <nav id="bottom-tabs">
    <button class="bot-tab active" data-page="page-home">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
      <span>首頁</span>
    </button>
    <button class="bot-tab" data-page="page-activities">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span>活動</span>
    </button>
    <button class="bot-tab" data-page="page-teams">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      <span>球隊</span>
    </button>
    <button class="bot-tab" data-page="page-tournaments">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 010-5C7 4 7 7 7 7"/><path d="M18 9h1.5a2.5 2.5 0 000-5C17 4 17 7 17 7"/><path d="M4 22h16"/><path d="M10 14.66V22"/><path d="M14 14.66V22"/><path d="M8 6v4a4 4 0 008 0V6H8z"/></svg>
      <span>賽事</span>
    </button>
    <button class="bot-tab" data-page="page-profile">
      <svg viewBox="0 0 24 24" width="22" height="22" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      <span>我的</span>
    </button>
  </nav>

  <!-- ============ 全域彈窗容器（由 PageLoader 載入 pages/modals.html） ============ -->
  <div id="modal-container"></div>

  <!-- Mode Badge -->
  <div id="mode-badge" class="mode-badge">DEMO</div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay" style="display:none">
    <div class="loading-spinner"></div>
    <div style="margin-top:.8rem;font-size:.85rem;color:var(--text-secondary)">載入中...</div>
  </div>
  <!-- 正式版：立即顯示載入指示器 + 安全兜底計時器 -->
  <script>
    if (document.documentElement.classList.contains('prod-early')) {
      document.getElementById('loading-overlay').style.display = '';
      // 安全兜底：最多顯示 20 秒載入畫面，避免永遠卡住
      window._loadingSafety = setTimeout(function() {
        var ov = document.getElementById('loading-overlay');
        if (ov && ov.style.display !== 'none') {
          ov.style.display = 'none';
          document.documentElement.classList.remove('prod-early');
          console.warn('[Boot] 載入逾時，強制隱藏載入畫面');
        }
      }, 20000);
    }
  </script>

  <!-- Firebase SDK + LIFF SDK 由 app.js 動態載入，不阻塞 DOMContentLoaded -->

  <!-- QR Code — 延遲載入（僅掃碼頁需要） -->
  <!-- 由 scan.js 動態載入，不再阻塞啟動 -->

  <!-- 多語言基礎 -->
  <script defer src="js/i18n.js?v=20260221f"></script>

  <!-- 基礎層 -->
  <script defer src="js/config.js?v=20260221f"></script>
  <script defer src="js/data.js?v=20260221f"></script>
  <script defer src="js/firebase-config.js?v=20260221f"></script>
  <script defer src="js/firebase-service.js?v=20260221f"></script>
  <script defer src="js/firebase-crud.js?v=20260221f"></script>
  <script defer src="js/api-service.js?v=20260221f"></script>
  <script defer src="js/line-auth.js?v=20260221f"></script>

  <!-- 頁面載入器 + 動態腳本載入器（必須在 App 之前） -->
  <script defer src="js/core/page-loader.js?v=20260221f"></script>
  <script defer src="js/core/script-loader.js?v=20260221f"></script>

  <!-- 核心（定義 App 物件 + init/renderAll/showToast） -->
  <script defer src="app.js?v=20260221f"></script>

  <!-- 核心擴充 -->
  <script defer src="js/core/navigation.js?v=20260221f"></script>
  <script defer src="js/core/theme.js?v=20260221f"></script>
  <script defer src="js/core/mode.js?v=20260221f"></script>

  <!-- 功能模組 -->
  <script defer src="js/modules/image-upload.js?v=20260221f"></script>
  <script defer src="js/modules/role.js?v=20260221f"></script>
  <script defer src="js/modules/profile-core.js?v=20260221f"></script>
  <script defer src="js/modules/profile-data.js?v=20260221f"></script>
  <script defer src="js/modules/profile-card.js?v=20260221f"></script>
  <script defer src="js/modules/banner.js?v=20260221f"></script>
  <script defer src="js/modules/ad-manage-core.js?v=20260221f"></script>
  <script defer src="js/modules/ad-manage-banner.js?v=20260221f"></script>
  <script defer src="js/modules/ad-manage-float.js?v=20260221f"></script>
  <script defer src="js/modules/ad-manage-popup-sponsor.js?v=20260221f"></script>
  <script defer src="js/modules/popup-ad.js?v=20260221f"></script>
  <script defer src="js/modules/announcement.js?v=20260221f"></script>
  <script defer src="js/modules/site-theme.js?v=20260221f"></script>
  <script defer src="js/modules/event-list.js?v=20260221f"></script>
  <script defer src="js/modules/event-detail.js?v=20260221f"></script>
  <script defer src="js/modules/event-manage.js?v=20260221f"></script>
  <script defer src="js/modules/event-create.js?v=20260221f"></script>
  <script defer src="js/modules/tournament-render.js?v=20260221f"></script>
  <script defer src="js/modules/tournament-manage.js?v=20260221f"></script>
  <script defer src="js/modules/team-list.js?v=20260221f"></script>
  <script defer src="js/modules/team-detail.js?v=20260221f"></script>
  <script defer src="js/modules/team-form.js?v=20260221f"></script>
  <script defer src="js/modules/message-inbox.js?v=20260221f"></script>
  <script defer src="js/modules/message-admin.js?v=20260221f"></script>
  <script defer src="js/modules/achievement.js?v=20260221f"></script>
  <script defer src="js/modules/favorites.js?v=20260221f"></script>
  <script defer src="js/modules/dashboard.js?v=20260221f"></script>
  <script defer src="js/modules/personal-dashboard.js?v=20260221f"></script>
  <script defer src="js/modules/shop.js?v=20260221f"></script>
  <script defer src="js/modules/leaderboard.js?v=20260221f"></script>
  <script defer src="js/modules/user-admin-list.js?v=20260221f"></script>
  <script defer src="js/modules/user-admin-exp.js?v=20260221f"></script>
  <script defer src="js/modules/auto-exp.js?v=20260221f"></script>
  <script defer src="js/modules/user-admin-roles.js?v=20260221f"></script>
  <script defer src="js/modules/scan.js?v=20260221f"></script>

  <!-- Service Worker Registration + 強制更新 -->
  <script>
    if ('serviceWorker' in navigator) {
      // 偵測 SW 更新 → 自動重載頁面（但不在初始化過程中重載，避免中斷 CDN 載入）
      navigator.serviceWorker.addEventListener('controllerchange', function() {
        if (!window._swReloading && !window._appInitializing) {
          window._swReloading = true; location.reload();
        }
      });
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' }).catch(function(){});
      });
    }
  </script>
  <!-- 腳本載入失敗兜底：顯示清快取按鈕 -->
  <script>
    window.addEventListener('error', function(e) {
      // 只攔截同源腳本載入失敗（CDN 動態載入的 script 由各自 onerror 處理，不顯示全域按鈕）
      if (e.target && e.target.tagName === 'SCRIPT' && e.target.src && e.target.src.indexOf(location.origin) === 0) {
        console.error('[Boot] Script failed:', e.target.src);
        var b = document.getElementById('_recovery_btn');
        if (!b) {
          b = document.createElement('button');
          b.id = '_recovery_btn';
          b.textContent = '載入失敗，點此清除快取重試';
          b.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:99999;padding:1rem 2rem;font-size:1rem;background:#dc2626;color:#fff;border:none;border-radius:8px;cursor:pointer';
          b.onclick = function() {
            if ('caches' in window) caches.keys().then(function(k){k.forEach(function(n){caches.delete(n)})});
            if ('serviceWorker' in navigator) navigator.serviceWorker.getRegistrations().then(function(r){r.forEach(function(w){w.unregister()})});
            setTimeout(function(){ location.reload(true); }, 300);
          };
          document.body.appendChild(b);
        }
      }
    }, true);
  </script>
</body>
</html>

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    //  SportHub Firestore Security Rules
    //  更新：2026-02-23
    //
    //  架構限制說明：
    //  目前使用 Firebase Anonymous Auth，request.auth.uid 為隨機匿名 UID，
    //  與 LINE userId（作為 users doc ID）不一致，因此無法在規則層做
    //  「只能寫自己的資料」的 owner 檢查。
    //
    //  長期建議：改用 Custom Claims（Cloud Functions 驗證 LINE ID Token
    //  後簽發 Firebase Custom Token，將 role 寫入 auth token），
    //  屆時可用 request.auth.token.role 做角色驗證。
    //
    //  當前策略：
    //  1. 每個集合獨立定義規則（消除 catch-all 萬用規則）
    //  2. 固定 slot 集合只允許 update（不可 create/delete）
    //  3. 日誌集合只允許 create（append-only，不可 update/delete）
    //  4. 建立時驗證必要欄位與資料型別
    //  5. 阻擋 ghost user（userId = 'unknown'）寫入
    //  6. 禁止從前端刪除 users 和 attendanceRecords
    // ═══════════════════════════════════════════════════════════════

    // ── 共用函式 ──

    function isAuth() {
      return request.auth != null;
    }

    function hasString(field) {
      return field in request.resource.data
        && request.resource.data[field] is string
        && request.resource.data[field].size() > 0;
    }

    function hasNumber(field) {
      return field in request.resource.data
        && request.resource.data[field] is number;
    }

    // ═══════════════════════════════════════════
    //  Events（活動）
    //  公開可讀；建立需驗證必要欄位
    // ═══════════════════════════════════════════
    match /events/{eventId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('title')
        && hasString('date')
        && hasString('location')
        && hasNumber('max')
        && request.resource.data.max > 0
        && hasNumber('current');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Users（用戶）
    //  登入可讀；建立需有 uid 和 displayName；
    //  禁止從前端刪除用戶文件
    // ═══════════════════════════════════════════
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && hasString('uid')
        && hasString('displayName');
      allow update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Registrations（報名）
    //  建立需有 eventId + userId（非 unknown）+ status
    // ═══════════════════════════════════════════
    match /registrations/{regId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && hasString('eventId')
        && hasString('userId')
        && request.resource.data.userId != 'unknown'
        && hasString('status');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Teams（球隊）
    //  公開可讀；建立需有名稱
    // ═══════════════════════════════════════════
    match /teams/{teamId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('name');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Tournaments（錦標賽）
    //  公開可讀；建立需有名稱
    // ═══════════════════════════════════════════
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('name');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Messages（訊息）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /messages/{msgId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && hasString('title');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Activity Records（活動紀錄）
    //  建立需有 eventId + uid（非 unknown）+ status
    // ═══════════════════════════════════════════
    match /activityRecords/{recordId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && hasString('eventId')
        && hasString('uid')
        && request.resource.data.uid != 'unknown'
        && hasString('status');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Attendance Records（簽到簽退）
    //  登入可讀寫；禁止刪除（審計軌跡）
    // ═══════════════════════════════════════════
    match /attendanceRecords/{recordId} {
      allow read: if isAuth();
      allow create: if isAuth()
        && hasString('eventId')
        && hasString('userId');
      allow update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Shop Items（二手商品）
    //  公開可讀；建立需有標題和價格
    // ═══════════════════════════════════════════
    match /shopItems/{itemId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('title')
        && hasNumber('price')
        && request.resource.data.price >= 0;
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Announcements（公告）
    //  公開可讀
    // ═══════════════════════════════════════════
    match /announcements/{annId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('title')
        && hasString('content');
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Achievements & Badges（成就與徽章）
    //  公開可讀
    // ═══════════════════════════════════════════
    match /achievements/{achId} {
      allow read: if true;
      allow write: if isAuth();
    }
    match /badges/{badgeId} {
      allow read: if true;
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  廣告系統 — 固定 Slot（banners / floatingAds / sponsors）
    //  公開可讀；只允許更新，禁止新增/刪除
    //  （Slot 由 seed 建立，前端只能修改內容）
    // ═══════════════════════════════════════════
    match /banners/{bannerId} {
      allow read: if true;
      allow create, update: if isAuth();
      allow delete: if false;
    }
    match /floatingAds/{adId} {
      allow read: if true;
      allow create, update: if isAuth();
      allow delete: if false;
    }
    match /sponsors/{sponsorId} {
      allow read: if true;
      allow create, update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Popup Ads（彈窗廣告）
    //  公開可讀；可新增/修改/刪除（非固定 slot）
    // ═══════════════════════════════════════════
    match /popupAds/{adId} {
      allow read: if true;
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Site Themes（佈景主題）— 固定 Slot
    //  公開可讀；只允許更新
    // ═══════════════════════════════════════════
    match /siteThemes/{themeId} {
      allow read: if true;
      allow create, update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Notification Templates（通知模板）— 固定 Slot
    //  登入可讀；只允許更新
    // ═══════════════════════════════════════════
    match /notifTemplates/{templateId} {
      allow read: if isAuth();
      allow update: if isAuth();
      allow create: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Logs（日誌）— Append-Only
    //  登入可讀可新增；禁止修改和刪除（不可竄改紀錄）
    // ═══════════════════════════════════════════
    match /expLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }
    match /teamExpLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }
    match /operationLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Roles & Permissions（角色與權限設定）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /customRoles/{roleId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }
    match /rolePermissions/{roleId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }
    match /permissions/{permId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Admin Messages（管理員廣播）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /adminMessages/{msgId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Matches / Standings（賽事數據）
    //  公開可讀
    // ═══════════════════════════════════════════
    match /matches/{matchId} {
      allow read: if true;
      allow write: if isAuth();
    }
    match /standings/{standingId} {
      allow read: if true;
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Trades（交易紀錄）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /trades/{tradeId} {
      allow read: if isAuth();
      allow write: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  LINE Push Queue（推播佇列）
    //  前端僅可新增 pending 狀態，後端 Admin SDK 處理
    // ═══════════════════════════════════════════
    match /linePushQueue/{docId} {
      allow read: if false;
      allow create: if isAuth()
        && request.resource.data.status == 'pending'
        && request.resource.data.uid is string
        && request.resource.data.title is string
        && request.resource.data.body is string;
      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Catch-all：未列出的集合一律拒絕
    //  如需新增集合，請在上方新增對應規則
    // ═══════════════════════════════════════════
    match /{collection}/{docId} {
      allow read: if false;
      allow write: if false;
    }
  }
}

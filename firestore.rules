rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════
    //  SportHub Firestore Security Rules
    //  更新：2026-02-26（緊急修復：手機 LINE 瀏覽器報名失敗）
    //
    //  安全策略：
    //  1. 用戶面集合：只要登入（isAuth）即可讀寫
    //  2. 敏感管理操作保留 admin/super_admin 限制
    //  3. 前端 ACL 控制細粒度權限，規則層只做基本閘門
    //  4. 禁止刪除 users / attendanceRecords（審計軌跡）
    //  5. isRestricted 帳號限制移至前端層面處理
    // ═══════════════════════════════════════════════════════════════

    // ── 共用函式 ──

    function isAuth() {
      return request.auth != null;
    }

    function isOwner(docId) {
      return request.auth != null && request.auth.uid == docId;
    }

    function roleFromUserDoc(uid) {
      let userPath = /databases/$(database)/documents/users/$(uid);
      let userDoc = exists(userPath) ? get(userPath) : null;
      return (userDoc != null && userDoc.data.role is string)
        ? userDoc.data.role
        : 'user';
    }

    function authRole() {
      return request.auth == null
        ? 'user'
        : ((request.auth.token.role is string)
          ? request.auth.token.role
          : roleFromUserDoc(request.auth.uid));
    }

    function isCoachPlus() {
      return request.auth != null
        && authRole() in ['coach', 'captain', 'venue_owner', 'admin', 'super_admin'];
    }

    function isAdmin() {
      return request.auth != null
        && authRole() in ['admin', 'super_admin'];
    }

    function isSuperAdmin() {
      return request.auth != null
        && authRole() == 'super_admin';
    }

    function isRestrictedAccount() {
      return request.auth != null
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isRestricted == true);
    }

    function isAuthNotRestricted() {
      return isAuth() && !isRestrictedAccount();
    }

    function sameFieldValue(field) {
      return (!(field in resource.data) && !(field in request.resource.data))
        || ((field in resource.data) && (field in request.resource.data)
          && request.resource.data[field] == resource.data[field]);
    }

    function hasString(field) {
      return field in request.resource.data
        && request.resource.data[field] is string
        && request.resource.data[field].size() > 0;
    }

    function hasNumber(field) {
      return field in request.resource.data
        && request.resource.data[field] is number;
    }

    function isResourceOwnerByField(field) {
      return isAuth()
        && (field in resource.data)
        && resource.data[field] is string
        && resource.data[field] == request.auth.uid;
    }

    function isTeamOwner() {
      return isResourceOwnerByField('captainUid')
        || isResourceOwnerByField('creatorUid')
        || isResourceOwnerByField('ownerUid');
    }

    function isShopItemOwner() {
      return isResourceOwnerByField('sellerUid')
        || isResourceOwnerByField('ownerUid')
        || isResourceOwnerByField('creatorUid')
        || isResourceOwnerByField('uid')
        || isResourceOwnerByField('userId');
    }

    function isTradeOwner() {
      return isResourceOwnerByField('fromUid')
        || isResourceOwnerByField('toUid')
        || isResourceOwnerByField('buyerUid')
        || isResourceOwnerByField('sellerUid')
        || isResourceOwnerByField('ownerUid')
        || isResourceOwnerByField('creatorUid')
        || isResourceOwnerByField('uid')
        || isResourceOwnerByField('userId');
    }

    function isMessageTargetOwner() {
      return isResourceOwnerByField('targetUid')
        || isResourceOwnerByField('uid')
        || isResourceOwnerByField('userId');
    }

    // ═══════════════════════════════════════════
    //  Events（活動）
    //  公開可讀；登入可寫（報名流程需更新人數計數）
    // ═══════════════════════════════════════════
    match /events/{eventId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('title');
      allow update: if isAuth();
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Users（用戶）
    //  登入可讀寫（與 events / teams / attendanceRecords 同級）
    //  敏感操作（角色變更等）由前端 ACL 控制
    //  禁止前端刪除（審計軌跡）
    // ═══════════════════════════════════════════
    match /users/{userId} {
      allow read: if isAuth();
      allow create: if isOwner(userId)
        && hasString('uid')
        && hasString('displayName');
      allow update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Registrations（報名）
    //  登入可讀寫（報名、取消報名、管理員代報名）
    // ═══════════════════════════════════════════
    match /registrations/{regId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Teams（球隊）
    //  公開可讀；登入可建立/更新/刪除
    // ═══════════════════════════════════════════
    match /teams/{teamId} {
      allow read: if true;
      allow create: if isAuth()
        && hasString('name');
      allow update: if isAuth();
      allow delete: if isAdmin() || isTeamOwner();
    }

    // ═══════════════════════════════════════════
    //  Tournaments（錦標賽）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /tournaments/{tournamentId} {
      allow read: if true;
      allow create: if isAdmin()
        && hasString('name');
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Messages（訊息）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /messages/{msgId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAuth();
    }

    // ═══════════════════════════════════════════
    //  Activity Records（活動紀錄）
    //  登入可讀可建立
    // ═══════════════════════════════════════════
    match /activityRecords/{recordId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Attendance Records（簽到簽退）
    //  登入可讀寫；禁止刪除（審計軌跡）
    // ═══════════════════════════════════════════
    match /attendanceRecords/{recordId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Shop Items（二手商品）
    //  公開可讀；登入可建立；owner/admin 可改刪
    // ═══════════════════════════════════════════
    match /shopItems/{itemId} {
      allow read: if true;
      allow create: if isAuth();
      allow update: if isAuth();
      allow delete: if isAdmin() || isShopItemOwner();
    }

    // ═══════════════════════════════════════════
    //  Announcements（公告）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /announcements/{annId} {
      allow read: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Achievements & Badges（成就與徽章）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /achievements/{achId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /badges/{badgeId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  廣告系統（banners / floatingAds / sponsors）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /banners/{bannerId} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    match /floatingAds/{adId} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if false;
    }
    match /sponsors/{sponsorId} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Popup Ads（彈窗廣告）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /popupAds/{adId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Site Themes（佈景主題）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /siteThemes/{themeId} {
      allow read: if true;
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Notification Templates（通知模板）
    //  登入可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /notifTemplates/{templateId} {
      allow read: if isAuth();
      allow create, update: if isAdmin();
      allow delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Logs（日誌）— 登入可讀可新增
    //  放寬 create 給所有登入用戶（auto-exp 等功能需要）
    // ═══════════════════════════════════════════
    match /expLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }
    match /teamExpLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }
    match /operationLogs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }
    match /errorLogs/{docId} {
      allow read: if isAuth()
        && request.auth.token.role == 'super_admin';
      allow create: if isAuth();
      allow update: if false;
      allow delete: if isAuth()
        && request.auth.token.role == 'super_admin';
    }

    // ═══════════════════════════════════════════
    //  Roles & Permissions（角色與權限設定）
    //  登入可讀；super_admin 可寫
    // ═══════════════════════════════════════════
    match /customRoles/{roleId} {
      allow read: if isAuth();
      allow write: if isSuperAdmin();
    }
    match /rolePermissions/{roleId} {
      allow read: if isAuth();
      allow write: if isSuperAdmin();
    }
    match /permissions/{permId} {
      allow read: if isAuth();
      allow write: if isSuperAdmin();
    }

    // ═══════════════════════════════════════════
    //  Admin Messages（管理員廣播）
    //  登入可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /adminMessages/{msgId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Matches / Standings（賽事數據）
    //  公開可讀；管理員可寫
    // ═══════════════════════════════════════════
    match /matches/{matchId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    match /standings/{standingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ═══════════════════════════════════════════
    //  Trades（交易紀錄）
    //  登入可讀寫
    // ═══════════════════════════════════════════
    match /trades/{tradeId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAdmin() || isTradeOwner();
    }

    // ═══════════════════════════════════════════
    //  LINE Push Queue（推播佇列）
    //  登入用戶可新增；後端 Admin SDK 消費（讀取/更新/刪除）
    // ═══════════════════════════════════════════
    match /linePushQueue/{docId} {
      allow read: if false;
      allow create: if isAuth();
      allow update, delete: if false;
    }

    // ═══════════════════════════════════════════
    //  Catch-all：未列出的集合一律拒絕
    // ═══════════════════════════════════════════
    match /{collection}/{docId} {
      allow read: if false;
      allow write: if false;
    }
  }
}
